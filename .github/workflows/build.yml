name: Build Halox 主路由完整版（全中文·API下载插件）

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: 清理空间
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo docker image prune -a -f

      - name: 拉取仓库
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: 编译缓存
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: 安装依赖
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses-dev \
          libssl-dev python3 python3-distutils rsync unzip zlib1g-dev \
          file wget curl ca-certificates ccache xz-utils tar jq

      - name: 克隆 ImmortalWrt 稳定版
        env:
          GIT_TERMINAL_PROMPT: "0"
        run: |
          set -e
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999
          git clone --depth=1 -b openwrt-24.10 https://github.com/immortalwrt/immortalwrt.git
          cd immortalwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 添加插件源码（GitHub API + Token，稳定）
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e
          cd immortalwrt

          fetch_api_tar() {
            name="$1"
            repo="$2"   # owner/repo
            ref="$3"    # branch/tag/sha
            dest="$4"
            url="https://api.github.com/repos/${repo}/tarball/${ref}"

            echo "==> Fetch $name from $url"
            rm -rf "$dest"
            mkdir -p "$dest"

            for i in 1 2 3; do
              echo "   attempt $i"
              rm -f /tmp/pkg.tgz

              # 用 token 拉，避免返回小错误页
              curl -L --retry 5 --retry-delay 2 --connect-timeout 20 \
                -H "Authorization: Bearer ${GH_TOKEN}" \
                -H "Accept: application/vnd.github+json" \
                -o /tmp/pkg.tgz "$url" || true

              # 校验是不是gzip（避免 14 bytes）
              if file /tmp/pkg.tgz | grep -qi 'gzip compressed'; then
                tar -xzf /tmp/pkg.tgz -C "$dest" --strip-components=1
                return 0
              else
                echo "   download not gzip, head:"
                head -c 200 /tmp/pkg.tgz || true
              fi
              sleep 3
            done

            echo "!! Failed to fetch $name"
            return 1
          }

          fetch_api_tar "passwall"  "xiaorouji/openwrt-passwall"   "master" "package/passwall"
          fetch_api_tar "openclash" "vernesong/OpenClash"          "master" "package/openclash"
          fetch_api_tar "nikki"     "nikkinikki-org/OpenWrt-nikki" "master" "package/nikki"
          fetch_api_tar "helloworld" "fw876/helloworld"            "master" "package/helloworld"

      - name: Halox 品牌设置（全中文）
        run: |
          cd immortalwrt

          # 主路由IP：192.168.2.1
          sed -i 's/192.168.1.1/192.168.2.1/g' package/base-files/files/bin/config_generate

          # 默认中文
          sed -i "s/option lang auto/option lang zh_cn/g" \
            feeds/luci/modules/luci-base/root/etc/config/luci || true

          # 系统名称：Halox定制固件
          sed -i 's/OpenWrt/Halox定制固件/g' package/base-files/files/bin/config_generate

          # 登录页标题
          sed -i 's/<title>.*<\/title>/<title>Halox定制固件 - 管理界面<\/title>/g' \
            feeds/luci/modules/luci-base/root/usr/lib/lua/luci/view/sysauth.htm || true

          # Argon 底部签名（超链接）
          sed -i '/<%+footer%>/i\
          <div style="text-align:center;padding:10px;font-size:12px;">\
          © 2025 <a href="https://halox.pages.dev/" target="_blank">Halox</a> | 微信：Chinchins\
          </div>' \
            feeds/luci/themes/luci-theme-argon/luasrc/view/themes/argon/footer.htm || true

      - name: 配置编译（全中文 + 全套插件）
        run: |
          cd immortalwrt

          echo "CONFIG_TARGET_x86=y" >> .config
          echo "CONFIG_TARGET_x86_64=y" >> .config
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config

          echo "CONFIG_PACKAGE_luci=y" >> .config

          # 中文语言包（基础 + 插件）
          echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-firewall-zh-cn=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-ttyd-zh-cn=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-passwall-zh-cn=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-openclash-zh-cn=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-nikki-zh-cn=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-adbyby-plus-zh-cn=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-adguardhome-zh-cn=y" >> .config

          # Argon
          echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-argon-config=y" >> .config

          # 科学插件
          echo "CONFIG_PACKAGE_luci-app-passwall=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-nikki=y" >> .config

          # 广告插件
          echo "CONFIG_PACKAGE_luci-app-adbyby-plus=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
          echo "CONFIG_PACKAGE_adguardhome=y" >> .config

          # 终端
          echo "CONFIG_PACKAGE_luci-app-ttyd=y" >> .config

          # Docker
          echo "CONFIG_PACKAGE_luci-app-docker=y" >> .config
          echo "CONFIG_PACKAGE_docker=y" >> .config
          echo "CONFIG_PACKAGE_dockerd=y" >> .config
          echo "CONFIG_PACKAGE_containerd=y" >> .config

          echo "CONFIG_CCACHE=y" >> .config
          make defconfig

      - name: 下载依赖
        run: |
          cd immortalwrt
          make download -j$(nproc)

      - name: 编译固件
        run: |
          cd immortalwrt
          make -j$(nproc)

      - name: 重命名固件（安全方式）
        run: |
          cd immortalwrt/bin/targets/x86/64/
          for f in *.img.gz; do
            mv "$f" "Halox-主路由完整版-$f"
          done

      - name: 上传固件
        uses: actions/upload-artifact@v4
        with:
          name: Halox-主路由完整版
          path: immortalwrt/bin/targets/x86/64/
