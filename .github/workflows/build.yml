name: Build Halox 主路由完整版（全中文·自动识别分支）

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: 清理空间
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo docker image prune -a -f

      - name: 拉取仓库
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: 编译缓存
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: 安装依赖
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses-dev \
          libssl-dev python3 python3-distutils rsync unzip zlib1g-dev \
          file wget curl ca-certificates ccache xz-utils tar jq

      - name: 克隆 ImmortalWrt 稳定版
        env:
          GIT_TERMINAL_PROMPT: "0"
        run: |
          set -e
          git clone --depth=1 -b openwrt-24.10 https://github.com/immortalwrt/immortalwrt.git
          cd immortalwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 添加插件源码（API + 自动默认分支）
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e
          cd immortalwrt

          get_default_branch() {
            repo="$1" # owner/repo
            curl -sL -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${repo}" | jq -r '.default_branch'
          }

          fetch_api_tar_default() {
            name="$1"
            repo="$2"
            dest="$3"

            branch="$(get_default_branch "$repo")"
            if [ -z "$branch" ] || [ "$branch" = "null" ]; then
              echo "!! cannot get default branch for $repo"
              exit 1
            fi

            url="https://api.github.com/repos/${repo}/tarball/${branch}"
            echo "==> Fetch $name (${repo}@${branch})"

            rm -rf "$dest"
            mkdir -p "$dest"

            for i in 1 2 3; do
              rm -f /tmp/pkg.tgz
              curl -L --retry 5 --retry-delay 2 --connect-timeout 20 \
                -H "Authorization: Bearer ${GH_TOKEN}" \
                -H "Accept: application/vnd.github+json" \
                -o /tmp/pkg.tgz "$url" || true

              if file /tmp/pkg.tgz | grep -qi 'gzip compressed'; then
                tar -xzf /tmp/pkg.tgz -C "$dest" --strip-components=1
                return 0
              else
                echo "not gzip, head:"
                head -c 200 /tmp/pkg.tgz || true
              fi
              sleep 3
            done

            echo "!! Failed to fetch $name"
            exit 1
          }

          fetch_api_tar_default "passwall"  "xiaorouji/openwrt-passwall"   "package/passwall"
          fetch_api_tar_default "openclash" "vernesong/OpenClash"          "package/openclash"
          fetch_api_tar_default "nikki"     "nikkinikki-org/OpenWrt-nikki" "package/nikki"
          fetch_api_tar_default "helloworld" "fw876/helloworld"            "package/helloworld"

      - name: Halox 品牌设置（全中文）
        run: |
          cd immortalwrt
          sed -i 's/192.168.1.1/192.168.2.1/g' package/base-files/files/bin/config_generate
          sed -i "s/option lang auto/option lang zh_cn/g" \
            feeds/luci/modules/luci-base/root/etc/config/luci || true
          sed -i 's/OpenWrt/Halox定制固件/g' package/base-files/files/bin/config_generate
          sed -i 's/<title>.*<\/title>/<title>Halox定制固件 - 管理界面<\/title>/g' \
            feeds/luci/modules/luci-base/root/usr/lib/lua/luci/view/sysauth.htm || true
          sed -i '/<%+footer%>/i\
          <div style="text-align:center;padding:10px;font-size:12px;">\
          © 2025 <a href="https://halox.pages.dev/" target="_blank">Halox</a> | 微信：Chinchins\
          </div>' \
            feeds/luci/themes/luci-theme-argon/luasrc/view/themes/argon/footer.htm || true

      - name: 配置编译（全中文 + 全套插件）
        run: |
          cd immortalwrt
          echo "CONFIG_TARGET_x86=y" >> .config
          echo "CONFIG_TARGET_x86_64=y" >> .config
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config
          echo "CONFIG_PACKAGE_luci=y" >> .config

          echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-firewall-zh-cn=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-ttyd-zh-cn=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-passwall-zh-cn=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-openclash-zh-cn=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-nikki-zh-cn=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-adbyby-plus-zh-cn=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-adguardhome-zh-cn=y" >> .config

          echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-argon-config=y" >> .config

          echo "CONFIG_PACKAGE_luci-app-passwall=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-nikki=y" >> .config

          echo "CONFIG_PACKAGE_luci-app-adbyby-plus=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
          echo "CONFIG_PACKAGE_adguardhome=y" >> .config

          echo "CONFIG_PACKAGE_luci-app-ttyd=y" >> .config

          echo "CONFIG_PACKAGE_luci-app-docker=y" >> .config
          echo "CONFIG_PACKAGE_docker=y" >> .config
          echo "CONFIG_PACKAGE_dockerd=y" >> .config
          echo "CONFIG_PACKAGE_containerd=y" >> .config

          echo "CONFIG_CCACHE=y" >> .config
          make defconfig

      - name: 下载依赖
        run: |
          cd immortalwrt
          make download -j$(nproc)

      - name: 编译固件
        run: |
          cd immortalwrt
          make -j$(nproc)

      - name: 重命名固件
        run: |
          cd immortalwrt/bin/targets/x86/64/
          for f in *.img.gz; do
            mv "$f" "Halox-主路由完整版-$f"
          done

      - name: 上传固件
        uses: actions/upload-artifact@v4
        with:
          name: Halox-主路由完整版
          path: immortalwrt/bin/targets/x86/64/
